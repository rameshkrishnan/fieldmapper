!function(){"use strict";angular.module("fieldmapper",[]).constant("d3",window.d3)}(),function(){"use strict";function t(t){function e(e,i){function n(){r.setWidth(i[0].offsetWidth).setMappingRef(e.mapping).draw(e.source,e.destination)}var s=i.html("<svg>").children()[0],r=new t(s);i.addClass("fieldmapper"),e.$watch("source",n,!0),e.$watch("destination",n,!0),e.$watch("mapping",n,!0)}var i={link:e,restrict:"EA",scope:{source:"=",destination:"=",mapping:"="}};return i}angular.module("fieldmapper").directive("fieldMapper",t),t.$inject=["FieldMapper"]}(),function(){"use strict";function t(t){function e(e){this.base=t.select(e),this.itemHeight=32,this.plotTitle=this.base.append("g").attr("class","plotTitle").attr("transform","translate(0, 0)"),this.plotSource=this.base.append("g").attr("class","plotSource").attr("transform","translate(0, 0)"),this.plotDestination=this.base.append("g").attr("class","plotDestination").attr("transform","translate(0, 0)"),this.plotConnect=this.base.append("g").attr("class","plotConnect").attr("transform","translate(0, 0)"),this.y=t.scale.ordinal()}return e.prototype.setWidth=function(t){return 350>t&&(t=350),this.rect_width=Math.round(40*t/100),this.gap=t-2*this.rect_width,this.base.attr("width",t),this},e.prototype.setMappingRef=function(t){return this.mapping=t,this},e.prototype.draw=function(e,i){function n(){var e=t.select(this),i=e.text(),n=i.length;n>15&&i.length>0&&(i=i.slice(0,15),e.text(i+"..."))}var s=this;this.source=e,this.destination=i;var r=this.itemHeight*(e.length+1);this.base.attr("height",r),this.y.domain(t.range(e.length)),this.y.rangeBands([this.itemHeight,r]),this.plotTitle.selectAll("*").remove(),this.plotTitle.append("rect").attr({"class":"box_title",x:0,y:0,height:this.itemHeight,width:this.rect_width}),this.plotTitle.append("text").attr({x:10,y:this.itemHeight/2,"class":"box_title"}).text("Source System"),this.plotTitle.append("rect").attr({"class":"box_title",x:this.rect_width+this.gap,y:0,height:this.itemHeight,width:this.rect_width}),this.plotTitle.append("text").attr({x:this.rect_width+this.gap+10,y:this.itemHeight/2,"class":"box_title"}).text("Destination System");var c=this.plotSource.selectAll(".bar").data(e);c.exit().remove();var a=c.enter(),l=a.append("g").attr("class","bar").attr("x",0);l.append("rect").attr({"class":"box",x:0,y:function(t,e){return s.y(e)},height:this.y.rangeBand(),width:this.rect_width,"data-ref":function(t){return t.columnName},id:function(t){return"s-rect-"+t.columnName}}).on("click",function(){s.selection(t.event.target)}),l.append("text").attr({"class":"field",x:10,y:function(t,e){return s.y(e)+s.y.rangeBand()/2},style:"text-anchor: start; dominant-baseline: middle",id:function(t){return"s-text-"+t.columnName}}).text(function(t){return t.columnName}).on("click",function(){s.selection(t.event.target.previousSibling)}),l.append("circle").attr({cx:this.rect_width-10,cy:function(t,e){return s.y(e)+s.y.rangeBand()/2},r:5,"data-ref":function(t){return t.columnName},id:function(t){return"s-circle-"+t.columnName}}).on("click",function(){s.selection(t.event.target.previousSibling.previousSibling)});var o=this.plotDestination.selectAll(".bar").data(i);e.length<i.length&&(r=this.itemHeight*(i.length+1),this.base.attr("height",r)),this.y.domain(t.range(i.length)),this.y.rangeBands([this.itemHeight,r]),o.exit().remove();var d=o.enter(),u=d.append("g").attr("class","bar").attr("x",this.rect_width+this.gap);u.append("rect").attr({"class":"box",x:this.rect_width+this.gap,y:function(t,e){return s.y(e)},height:this.y.rangeBand(),width:this.rect_width,"data-ref":function(t){return t.columnName},id:function(t){return"d-rect-"+t.columnName}}).on("click",function(){s.linkage(t.event.target)}),u.append("text").attr({"class":"field",x:this.rect_width+this.gap+20,y:function(t,e){return s.y(e)+s.y.rangeBand()/2},style:"text-anchor: start; dominant-baseline: middle",id:function(t){return"d-text-"+t.columnName}}).text(function(t){return t.columnName}).on("click",function(){s.linkage(t.event.target.previousSibling)}),u.append("circle").attr({cx:this.rect_width+this.gap+10,cy:function(t,e){return s.y(e)+s.y.rangeBand()/2},r:5,id:function(t){return"d-circle-"+t.columnName}}).on("click",function(){s.linkage(t.event.target.previousSibling.previousSibling)}),this.base.selectAll("text.field").each(n),this.drawMapping()},e.prototype.drawMapping=function(){var e=this,i=[];i=this.mapping.filter(function(t){var i=!1,n=!1;return e.source.forEach(function(e){e.id==t.source&&(i=!0)}),e.destination.forEach(function(e){e.id==t.destination&&(n=!0)}),!(!i||!n)}),i.forEach(function(t){e.mapping.push(t)});var n=this.plotConnect.selectAll(".connect").data(this.mapping);n.exit().remove();var s=n.enter(),r=s.append("g").attr({"class":"connect",id:function(t){return"connect-"+t.source}});r.append("line").attr({x1:function(e){return t.select("#s-circle-"+e.source).attr("cx")},y1:function(e){return t.select("#s-circle-"+e.source).attr("cy")},x2:function(e){return t.select("#d-circle-"+e.destination).attr("cx")},y2:function(e){return t.select("#d-circle-"+e.destination).attr("cy")},"s-ref":function(t){return t.source},"d-ref":function(t){return t.destination}}).style({stroke:"black","stroke-width":"4px"}).on("dblclick",function(){var i=t.select(t.event.target);i.parentNode;t.select("#s-circle-"+i.attr("s-ref")).attr("data-linked",""),t.select("#s-circle-"+i.attr("s-ref")).classed("linked",!1),t.select("#s-rect-"+i.attr("s-ref")).classed("linked",!1),t.select("#s-text-"+i.attr("s-ref")).classed("linked",!1),t.select("#d-circle-"+i.attr("d-ref")).attr("data-linked",""),t.select("#d-circle-"+i.attr("d-ref")).classed("linked",!1),t.select("#d-rect-"+i.attr("d-ref")).classed("linked",!1),t.select("#d-text-"+i.attr("d-ref")).classed("linked",!1),t.select("#connect-"+i.attr("s-ref")).remove(),e.mapping.forEach(function(t,n){return t.source==i.attr("s-ref")?void setTimeout(function(){e.mapping.splice(n,1)},0):void 0})}).each(function(e){t.select("#s-circle-"+e.source).attr("data-linked","true"),t.select("#s-circle-"+e.source).classed("linked",!0),t.select("#s-rect-"+e.source).classed("linked",!0),t.select("#s-text-"+e.source).classed("linked",!0),t.select("#d-circle-"+e.destination).attr("data-linked","true"),t.select("#d-circle-"+e.destination).classed("linked",!0),t.select("#d-rect-"+e.destination).classed("linked",!0),t.select("#d-text-"+e.destination).classed("linked",!0)})},e.prototype.selection=function(e){var i=t.select(e),n=i.attr("data-ref");"true"!=t.select("#s-circle-"+n).attr("data-linked")&&(t.selectAll(".plotSource circle").classed("selected",!1),t.select("#s-circle-"+n).classed("selected",!0),t.selectAll(".plotSource rect").classed("selected",!1),t.select("#s-rect-"+n).classed("selected",!0),t.selectAll(".plotSource text").classed("selected",!1),t.select("#s-text-"+n).classed("selected",!0))},e.prototype.linkage=function(e){var i=t.select(e),n=i.attr("data-ref");if("true"!=t.select("#d-circle-"+n).attr("data-linked")){var s=t.select(".plotSource circle.selected"),r=s.attr("data-ref");if(null===s[0][0])return;this.mapping.push({source:s.attr("data-ref"),destination:n}),s.classed("selected",!1),t.select("#s-rect-"+r).classed("selected",!1),t.select("#s-text-"+r).classed("selected",!1),this.drawMapping()}},e}angular.module("fieldmapper").factory("FieldMapper",t),t.$inject=["d3"]}();